<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Sojiro's Blog]]></title>
  <link href="http://sojiro14.github.io/atom.xml" rel="self"/>
  <link href="http://sojiro14.github.io/"/>
  <updated>2015-01-28T13:12:58+09:00</updated>
  <id>http://sojiro14.github.io/</id>
  <author>
    <name><![CDATA[Sojiro]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[HUBOTを使ったirc-bot作成メモ]]></title>
    <link href="http://sojiro14.github.io/blog/2014/04/19/irc-bot-by-hubot/"/>
    <updated>2014-04-19T21:05:49+09:00</updated>
    <id>http://sojiro14.github.io/blog/2014/04/19/irc-bot-by-hubot</id>
    <content type="html"><![CDATA[<h2>①HUBOTを動かすために必要な諸々のインストール</h2>

<h3>準備として以下をインストールする</h3>

<ul>
<li>node.js（サーバー）</li>
<li>npm（パッケージ管理コマンド）</li>
<li>Redis（KVS）</li>
</ul>


<h3>上記をインストールするためにHomebrewのインストールから始める</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>ruby -e <span class="s2">&quot;$(curl -fsSL https://raw.github.com/mxcl/homebrew/go/install)&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>これでHomebrewが入るはず</p>

<h3>次にHomebrewを使ってそれぞれインストールする</h3>

<p>まずnode.jsとnpm</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>brew install node
</span></code></pre></td></tr></table></div></figure>


<p>このコマンド一発でnode.jsとnpmが入るはず</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>node -v
</span><span class='line'>v0.10.26
</span><span class='line'><span class="nv">$ </span>npm -v
</span><span class='line'>1.4.6
</span></code></pre></td></tr></table></div></figure>


<h3>Redisもインストール</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>brew install redis
</span></code></pre></td></tr></table></div></figure>


<h3>Redisを起動しておく</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>redis-server <span class="p">&amp;</span>
</span></code></pre></td></tr></table></div></figure>


<h2>②HUBOTをインストールする</h2>

<h3>GitHubからリポジトリをクローンしてインストール</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span><span class="nb">cd </span>git/
</span><span class='line'><span class="nv">$ </span>git clone git://github.com/github/hubot.git
</span><span class='line'><span class="nv">$ </span><span class="nb">cd </span>hubot/
</span><span class='line'><span class="nv">$ </span>npm install -g hubot coffee-script
</span></code></pre></td></tr></table></div></figure>


<h3>動くか確認</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>hubot
</span><span class='line'>Hubot&gt;
</span></code></pre></td></tr></table></div></figure>


<p>OK</p>

<h2>③HUBOTをircと連携させる</h2>

<h3>自分用のHUBOTを作る</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>hubot --create myhubot
</span></code></pre></td></tr></table></div></figure>


<p>myhubotの部分は自由に変更可。この名前のディレクトリが作られる</p>

<h3>自分用HUBOTにhubot-ircをインストール</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span><span class="nb">cd </span>myhubot/
</span><span class='line'><span class="nv">$ </span>npm install hubot-irc --save <span class="o">&amp;&amp;</span> npm install
</span></code></pre></td></tr></table></div></figure>


<h3>irc連携のためのスクリプトを書く</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>vim runhubot
</span></code></pre></td></tr></table></div></figure>


<p>中身はこんな感じ</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>cat runhubot
</span><span class='line'><span class="c">#!/bin/bash</span>
</span><span class='line'>
</span><span class='line'><span class="nb">export </span><span class="nv">HUBOT_IRC_NICK</span><span class="o">=</span><span class="s2">&quot;bot_kun&quot;</span>
</span><span class='line'><span class="nb">export </span><span class="nv">HUBOT_IRC_ROOMS</span><span class="o">=</span><span class="s2">&quot;#target_channel&quot;</span>
</span><span class='line'><span class="nb">export </span><span class="nv">HUBOT_IRC_SERVER</span><span class="o">=</span><span class="s2">&quot;irc.hogehoge.local&quot;</span>
</span><span class='line'><span class="c">#export HUBOT_IRC_PASSWORD=&quot;hoge&quot;</span>
</span><span class='line'>
</span><span class='line'>bin/hubot -a irc --name myhubot
</span></code></pre></td></tr></table></div></figure>


<h3>スクリプトの実行権限追加</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>chmod u+x runhubot
</span></code></pre></td></tr></table></div></figure>


<h3>起動スクリプト実行！</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>./runhubot <span class="p">&amp;</span>
</span></code></pre></td></tr></table></div></figure>


<h3>irc上でbotがいるか確認する</h3>

<p>bot_kunがいたのでOK</p>

<h2>④botにさせたいことを設定する</h2>

<h3>HUBOTにさせたいことはscriptsディレクトリ以下にCoffeeScriptもしくはJavaScriptで記述する</h3>

<p>最初からいくつかのスクリプトが存在するので、それを参考に書けばOK</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>vim scripts/tell_fuga.coffee
</span><span class='line'><span class="nv">$ </span>cat scripts/tell_fuga.coffee
</span><span class='line'>module.exports <span class="o">=</span> <span class="o">(</span>robot<span class="o">)</span> -&gt;
</span><span class='line'>
</span><span class='line'>  robot.hear /hoge/, <span class="o">(</span>msg<span class="o">)</span> -&gt;
</span><span class='line'>      msg.send <span class="s2">&quot;fuga&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<h3>スクリプトを書いたら、再起動すると読み込んでくれる</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>./runhubot <span class="p">&amp;</span>
</span></code></pre></td></tr></table></div></figure>


<h2>⑤cronが使えるようにする</h2>

<h3>node-cronをインストール</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>npm install cron
</span></code></pre></td></tr></table></div></figure>


<h3>cronを使ったスクリプトを書く</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>vim scripts/mention_hoge.coffee
</span></code></pre></td></tr></table></div></figure>


<h3>今回は2時間おきに発言するスクリプトを書いてみた</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>cat scripts/mention_hoge.coffee
</span><span class='line'><span class="nv">cron</span> <span class="o">=</span> require<span class="o">(</span><span class="s1">&#39;cron&#39;</span><span class="o">)</span>.CronJob
</span><span class='line'>module.exports <span class="o">=</span> <span class="o">(</span>robot<span class="o">)</span> -&gt;
</span><span class='line'>  robot.enter -&gt;
</span><span class='line'>  new cron
</span><span class='line'>    cronTime: <span class="s2">&quot;0 0 */2 * * *&quot;</span>
</span><span class='line'>    start: <span class="nb">true</span>
</span><span class='line'><span class="nb">    </span>timeZone: <span class="s2">&quot;Asia/Tokyo&quot;</span>
</span><span class='line'>    onTick: -&gt;
</span><span class='line'>      robot.send <span class="o">{</span>room: <span class="s2">&quot;#target_channel&quot;</span><span class="o">}</span>, <span class="s2">&quot;hoge&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<h2>参考資料</h2>

<ul>
<li><a href="http://www.tettori.net/post/293/">5分で終了。node.jsの環境構築が拍子抜けするほど簡単だったのでサンプルプログラム付きでまとめてみました【Mac編】</a></li>
<li><a href="http://bulblub.com/2013/04/20/install_nodejs_with_homebrew/">Homebrewでnode.jsとnpmをインストール</a></li>
<li><a href="http://tech-sketch.jp/2013/12/hubot-install-heroku.html">GitHubがOpsツールの中心として活用しているHubotを使ってみる</a></li>
<li><a href="http://d.hatena.ne.jp/anatoo/20120204/1328368042">github社製ボットフレームワーク、hubotをIRCボットとして導入した話</a></li>
<li><a href="http://mayo.hatenablog.com/entry/2013/10/15/074237">Redis 入門</a></li>
<li>GitHub

<ul>
<li><a href="https://github.com/nandub/hubot-irc">https://github.com/nandub/hubot-irc</a></li>
<li><a href="https://github.com/ncb000gt/node-cron">https://github.com/ncb000gt/node-cron</a></li>
</ul>
</li>
<li><a href="http://com4tis.net/2013/05/30/node-js-background-pid-stop/">Node.jsをバックグラウンドでプロセスとして動かしたものを停止させる</a>

<ul>
<li>→もっといい方法あるはず。。。</li>
</ul>
</li>
</ul>

]]></content>
  </entry>
  
</feed>
